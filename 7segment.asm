;Drive 7segment

.include "registers.inc"

.equ SEGON=0xFF	;7SEG ON WAIT TIME
.equ SEGONH=0x1C	;7SEG ON WAIT TIME
.equ SEGONL=0xFF	;7SEG ON WAIT TIME
.equ SEGOFF=1	;7SEG OFF WAIT TIME

SEG_ALLOFF:
		SBI PORTD,PORTD0
		SBI PORTD,PORTD1
		SBI PORTD,PORTD4
		SBI PORTD,PORTD5

		;OUTPUT blank
		LDI GX,SEGBL
		OUT PORTB,GX
		RET

SEG:
		;SEGMENT1
		SBI PORTD,PORTD0
		SBI PORTD,PORTD1
		SBI PORTD,PORTD4
		CBI PORTD,PORTD5
		MOV ARG1,SEC_L
		RCALL PER_SEGMENT

		;SEGMENT2
		SBI PORTD,0
		SBI PORTD,1
		CBI PORTD,4
		SBI PORTD,5
		MOV ARG1,SEC_H
		RCALL PER_SEGMENT

		;SEGMENT3
		SBI PORTD,0
		CBI PORTD,1
		SBI PORTD,4
		SBI PORTD,5
		MOV ARG1,MIN_L
		RCALL PER_SEGMENT

		;SEGMENT4
		CBI PORTD,0
		SBI PORTD,1
		SBI PORTD,4
		SBI PORTD,5
		MOV ARG1,MIN_H
		RCALL PER_SEGMENT

		RET

PER_SEGMENT:
		;Output to Segment
		;ARG1 = data to segment

		;Convert BCD to Segment
		MOV GX,ARG1
		RCALL BCDTOSEG
		OUT PORTB,RETURN	;OUTPUT

		;WAIT(on)
		LDI ZH,SEGONH
		LDI ZL,SEGONL
		RCALL WAIT16

		;OUTPUT blank
		LDI GX,SEGBL
		OUT PORTB,GX

		;WAIT(off)
		LDI ARG1,SEGOFF
		RCALL WAIT

		RET
